# https://github.com/marketplace/actions/publish-vs-code-extension
on:
  push:
    branches:
      - main
      - master

name: publish
jobs:
  # extract "version" from package.json and set it as an output
  get_current_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v2
      - run: |
          echo "::set-output name=version::$(jq -r .version package.json)"
        id: get_version

  get_previous_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.before }}
      - run: |
          echo "::set-output name=version::$(jq -r .version package.json)"
        id: get_version

  deploy:
    # only run if the version has changed
    needs:
      - get_current_version
      - get_previous_version
    if: ${{ needs.get_current_version.outputs.version != needs.get_previous_version.outputs.version }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 16
      - run: yarn
      - run: yarn compile
      # - name: Publish to Open VSX Registry
      #   uses: HaaLeo/publish-vscode-extension@v1
      #   with:
      #     pat: ${{ secrets.OPEN_VSX_TOKEN }}
      #     yarn: true
      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v1
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          registryUrl: https://marketplace.visualstudio.com
          yarn: true
